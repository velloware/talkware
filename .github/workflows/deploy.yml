name: Deploy - Production - talkware.velloware.com

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@master
      - name: Copy repository contents via scp
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          PORT: ${{ secrets.PORT }}
          source: '.'
          target: '/var/www/talkware.velloware.com'
          overwrite: true
      - name: Deployng the project branch ${{ github.ref_name }} in /var/www/talkware.velloware.com
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          PORT: ${{ secrets.PORT }}
          script: |
            sudo chown -R $USER /var/www/talkware.velloware.com
            cd /var/www/talkware.velloware.com
            echo "\n\nDeploying the project branch ${{ github.ref_name }} in /var/www/talkware.velloware.com" >> /var/www/logs/${{ github.repository }}/${{ github.sha }}/deploy.log
            sudo docker stop talkware-backend >> /var/www/logs/${{ github.repository }}/${{ github.sha }}/deploy.log
            sudo docker rm talkware-backend >> /var/www/logs/${{ github.repository }}/${{ github.sha }}/deploy.log
            sudo docker build -t "talkware-backend" --rm --build-arg PM2_PUBLIC_KEY_ARG=${{ secrets.PM2A }} --build-arg PM2_SECRET_KEY_ARG=${{ secrets.PM2B }} . >> /var/www/logs/${{ github.repository }}/${{ github.sha }}/deploy.log
            sudo docker run --name talkware-backend -p 5337:5337 -d talkware-backend >> /var/www/logs/${{ github.repository }}/${{ github.sha }}/deploy.log
            curl --request POST --url https://dash.velloware.com/api/notification --header 'Content-Type: application/json' --data '{"message": "Deploing ${{ github.repository }} - â›‘${{ github.ref_name }}ðŸ“¢\n on Vello-1-server (acess: talkware.velloware.com)\n\nby: ${{ github.actor }}"}'
